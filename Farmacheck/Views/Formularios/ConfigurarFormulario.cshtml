@model Farmacheck.Models.CuestionarioViewModel

@{
    var isEditing = Model.Id != 0;
    ViewData["Title"] = isEditing ? "Actualizar" : "Guardar";
}

@section Styles {
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
}

<div class="container-fluid p-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <a class="btn btn-success" style="background-color: #0c4c98 !Important; color: white;"
           href="@Url.Action("Index", "Formularios", new { id = ViewBag.FormularioId })">
            <i class="bi bi-arrow-left"></i> Regresar
        </a>
        <button type="button" class="btn btn-secondary" id="btnAsignaciones">Asignaciones</button>
    </div>
    <h4 class=" text-white p-3 rounded" style="background-color:#0c4c98">@(isEditing ? "Actualizar Checklist" : "Guardar Checklist")</h4>

    <form id="formFormulario">
        <input type="hidden" asp-for="Id" />
        <!-- Fila: Nombre - Alias - Etiqueta - Estándar -->
        <fieldset class="border p-3 mb-4 rounded">
            <legend class="w-auto px-2 text-secondary">Datos Generales</legend>

            <div class="row mb-3">
                <div class="col-md-4">
                    <label>Nombre del formulario</label>
                    <input asp-for="Nombre" class="form-control form-control-ajustada" />
                </div>
                <div class="col-md-4">
                    <label>Alias del formulario</label>
                    <input asp-for="Alias" class="form-control form-control-ajustada" />
                </div>
                <div class="col-md-4">
                    <label>Categoría</label>
                    <select class="form-select" id="categoria"></select>
                </div>
            </div>

            <div class="row">
                <div class="col-md-8">
                    <label>Descripción</label>
                    <input asp-for="Descripcion" class="form-control form-control-ajustada" />
                </div>
                
                <div class="col-md-4">
                    <div class="mb-2">
                        <label>Nombre del archivo con la imagen</label>
                        <input type="file" class="form-control" id="imagenArchivo" accept="image/*" />
                        <input type="text" class="form-control mt-2" id="imagenNombre" readonly />
                        <input type="hidden" id="imagenBase64" />
                    </div>
                </div>
            </div>
        </fieldset>

        <!-- Fila: Auditor - Auditado - Supervisor - Unidad de Negocio -->
        <fieldset class="border p-3 mb-4 rounded">
            <legend class="w-auto px-2 text-secondary">Asignación del formulario</legend>
            <div class="row mb-3">
                <div class="col-md-3">
                    <label>Auditor</label>
                    @Html.DropDownListFor(m => m.Auditor, Model.AuditoresDisponibles, "-- Seleccione --", new { @class = "form-control form-control-ajustada" })
                </div>
                <div class="col-md-3">
                    <label>Auditado</label>
                    @Html.DropDownListFor(m => m.Auditado, Model.AuditadosDisponibles, "-- Seleccione --", new { @class = "form-control form-control-ajustada" })
                </div>
                <div class="col-md-3">
                    <label>Supervisor</label>
                    @Html.DropDownListFor(m => m.Supervisor, Model.SupervisoresDisponibles, "-- Seleccione --", new { @class = "form-control form-control-ajustada" })
                </div>
                <div class="col-md-3">
                    <label>Unidad de Negocio</label>
                    @Html.DropDownListFor(m => m.UnidadNegocio, Model.UnidadesDisponibles, "-- Seleccione --", new { @class = "form-control form-control-ajustada" })
                </div>
            </div>
        </fieldset>

        <!-- Configuración de firma -->
        <fieldset class="border p-3 mb-4 rounded">
            <legend class="w-auto px-2 text-secondary">Configuración de firma</legend>
            <div class="row mb-3 align-items-end">
                <div class="col-md-4">
                    <div class="form-check">
                        <input class="form-check-input" asp-for="PersonalizarFirmasAdicionales" />
                        <label class="form-check-label">Personalizar firmas adicionales</label>
                    </div>
                </div>
                <div class="col-md-4">
                    <label>Etiqueta 1</label>
                    <input asp-for="EtiquetaDeFirma1" class="form-control form-control-ajustada" />
                </div>
                <div class="col-md-4">
                    <label>Etiqueta 2</label>
                    <input asp-for="EtiquetaDeFirma2" class="form-control form-control-ajustada" />
                </div>
            </div>
        </fieldset>

        <!-- Notificaciones -->
        <fieldset class="border p-3 mb-4 rounded">
            <legend class="w-auto px-2 text-secondary">Configuración de Notificaciones</legend>

            <!-- Notificación por correo al finalizar revisión -->
            <div class="row mb-3 align-items-center">
                <div class="col-md-5 d-flex align-items-center">
                    <div class="form-check m-0">
                        <input class="form-check-input" asp-for="NotificacionesPorCorreoAlFinalizarRevision" />
                        <label class="form-check-label ms-2">Notificaciones por correo al finalizar la revisión</label>
                    </div>
                </div>
                <div class="col-md-7">
                    <label class="mb-1">Con notificaciones por correo adicionales a:</label>
                    <input asp-for="ListadoDeCorreosParaNotifiacionAlFinalizarAdicionales" class="form-control form-control-ajustada" />
                </div>
            </div>
        </fieldset>

        <!-- PDF -->
        <fieldset class="border p-3 mb-4 rounded">
            <legend class="w-auto px-2 text-secondary">Personalización de PDF</legend>
            <div class="row mb-3">
                <div class="col-md-6">
                    <div class="form-check">
                        <input class="form-check-input" asp-for="SustituirLogoEnPDF" />
                        <label class="form-check-label">Sustituir logo en PDF</label>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-check">
                        <input class="form-check-input" asp-for="SustituirLogoEnEmpresa" />
                        <label class="form-check-label">Sustituir empresa en PDF</label>
                    </div>
                </div>
            </div>
        </fieldset>

        <!-- Extras -->
        <fieldset class="border p-3 mb-4 rounded">
            <legend class="w-auto px-2 text-secondary">Extras</legend>

            <div class="row mb-3">
                <div class="col-md-3">
                    <div class="form-check">
                        <input class="form-check-input" asp-for="ActivarGeolocalizacionEnCuestionario" />
                        <label class="form-check-label">Activar geolocalización</label>
                    </div>
                </div>

                <div class="col-md-3">
                    <div class="form-check">
                        <input class="form-check-input" asp-for="EsconderCalificacion" />
                        <label class="form-check-label">Esconder Calificación</label>
                    </div>
                </div>

                <div class="col-md-3">
                    <div class="form-check">
                        <input class="form-check-input" asp-for="OcultarTareasPendientes" />
                        <label class="form-check-label">Ocultar tareas pendientes</label>
                    </div>
                </div>

                <div class="col-md-3">
                    <div class="form-check">
                        <input class="form-check-input" asp-for="PublicarCuestionario" />
                        <label class="form-check-label">Publicar</label>
                    </div>
                </div>
            </div>
        </fieldset>

        <!-- Semaforo -->
        <fieldset class="border p-3 mb-4 rounded">
            <legend class="w-auto px-2 text-secondary">Semáforo de Rangos</legend>

            <div class="mb-2">
                <div class="input-group mb-2">
                    <span class="input-group-text bg-success text-white"><i class="bi bi-circle-fill"></i></span>
                    <input type="number" class="form-control" id="RangoVerde" placeholder="Rango verde">
                </div>

                <div class="input-group mb-2">
                    <span class="input-group-text bg-warning text-white"><i class="bi bi-circle-fill"></i></span>
                    <input type="number" class="form-control" id="RangoAmarillo" placeholder="Rango amarillo">
                </div>

                <div class="input-group">
                    <span class="input-group-text bg-danger text-white"><i class="bi bi-circle-fill"></i></span>
                    <input type="number" class="form-control" id="RangoRojo" placeholder="Rango rojo">
                </div>
            </div>
        </fieldset>

        <!-- Botones -->
        <div class="form-group mt-4 text-end">
            <button type="button" id="btnGuardarFormulario" class="btn btn-primary">@(isEditing ? "Actualizar" : "Guardar")</button>
            <a href="@Url.Action("Index", "Formularios")" class="btn btn-outline-secondary">Cancelar</a>
        </div>
    </form>

    <!-- Modal de guardado -->
    <div class="modal fade" id="modalGuardado" tabindex="-1" aria-labelledby="modalGuardadoLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary_form text-white">
                    <h5 class="modal-title" id="modalGuardadoLabel">Checklist</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="mensajeGuardado"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="btnAceptarGuardado">Aceptar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de asignaciones -->
    <div class="modal fade" id="modalAsignaciones" tabindex="-1" aria-labelledby="modalAsignacionesLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary_form text-white">
                    <h5 class="modal-title" id="modalAsignacionesLabel">Asignaciones</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="idFormularioAsignacion" />
                    <div class="mb-3">
                        <label>Rol 1</label>
                        <select id="rolSelect1" class="form-select" multiple>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label>Rol 2</label>
                        <select id="rolSelect2" class="form-select">
                            <option value="">-- Seleccione --</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label>Rol 3</label>
                        <select id="rolSelect3" class="form-select" multiple>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="btnGuardarAsignaciones">Guardar</button>
                </div>
            </div>
        </div>
    </div>

</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        $(document).ready(function () {
            cargarCategorias();

             $('#imagenArchivo').change(function () {
                const file = this.files[0];
                $('#imagenNombre').val(file ? file.name : '');
            });

            const params = new URLSearchParams(window.location.search);
            const id = params.get('id');
            $('#idFormularioAsignacion').val(id);
            if (id) {
                $.get('@Url.Action("ObtenerFormulario", "Formularios")', { id }, function (r) {
                    if (r.success) {
                        const f = r.data;
                        $('#Id').val(f.id);
                        $('#Nombre').val(f.nombre);
                        $('#Alias').val(f.alias);
                        $('#Descripcion').val(f.descripcion);
                        $('#categoria').val(f.categoriaId);
                        $('#imagenNombre').val(f.nombreDelArchivoConLaImagen);
                        $('#FirmaObligatoria').prop('checked', f.firmaObligatoria);
                        $('#PersonalizarFirmas').prop('checked', f.personalizarFirmas);
                        $('#EtiquetaDeFirma1').val(f.etiquetaDeFirma1);
                        $('#EtiquetaDeFirma2').val(f.etiquetaDeFirma2);
                        $('#NotificacionesPorCorreoAlFinalizarRevision').prop('checked', f.notificacionesPorCorreoAlFinalizarRevision);
                        $('#ListadoDeCorreosParaNotifiacionAlFinalizarAdicionales').val(f.listadoDeCorreosParaNotifiacionAlFinalizarAdicionales);
                        $('#PersonalizarFirmasAdicionales').prop('checked', f.personalizarFirmasAdicionales);
                        $('#SustituirLogoEnPDF').prop('checked', f.sustituirLogoEnPDF);
                        $('#SustituirLogoEnEmpresa').prop('checked', f.sustituirLogoEnEmpresa);
                        $('#OcultarTareasPendientes').prop('checked', f.ocultarTareasPendientes);
                        $('#EsconderCalificacion').prop('checked', f.esconderCalificacion);
                        $('#ActivarGeolocalizacionEnCuestionario').prop('checked', f.esconderCalificacion);
                        $('#PublicarCuestionario').prop('checked', f.publicarCuestionario);
                        $('#RangoVerde').val(f.rangoVerde);
                        $('#RangoAmarillo').val(f.rangoAmarillo);
                        $('#RangoRojo').val(f.rangoRojo);
                    } else {
                        showAlert('No se encontró el formulario', 'error');
                    }
                });
            }
        });

        $('#btnGuardarFormulario').click(function () {
            const data = {
                Id: parseInt($('#Id').val() || 0),
                Nombre: $('#Nombre').val(),
                Alias: $('#Alias').val(),
                Descripcion: $('#Descripcion').val(),
                CategoriaId: $('#categoria').val(),
                NombreDelArchivoConLaImagen: $('#imagenNombre').val(),
                FirmaObligatoria: $('#FirmaObligatoria').is(':checked'),
                PersonalizarFirmas: $('#PersonalizarFirmas').is(':checked'),
                EtiquetaDeFirma1: $('#EtiquetaDeFirma1').val(),
                EtiquetaDeFirma2: $('#EtiquetaDeFirma2').val(),
                NotificacionesPorCorreoAlFinalizarRevision: $('#NotificacionesPorCorreoAlFinalizarRevision').is(':checked'),
                ListadoDeCorreosParaNotifiacionAlFinalizarAdicionales: $('#ListadoDeCorreosParaNotifiacionAlFinalizarAdicionales').val(),
                PersonalizarFirmasAdicionales: $('#PersonalizarFirmasAdicionales').is(':checked'),
                SustituirLogoEnPDF: $('#SustituirLogoEnPDF').is(':checked'),
                SustituirLogoEnEmpresa: $('#SustituirLogoEnEmpresa').is(':checked'),
                OcultarTareasPendientes: $('#OcultarTareasPendientes').is(':checked'),
                EsconderCalificacion: $('#EsconderCalificacion').is(':checked'),
                ActivarGeolocalizacionEnCuestionario: $('#ActivarGeolocalizacionEnCuestionario').is(':checked'),
                PublicarCuestionario: $('#PublicarCuestionario').is(':checked'),
                RangoVerde: $('#RangoVerde').val() || 0,
                RangoAmarillo: $('#RangoAmarillo').val() || 0,
                RangoRojo: $('#RangoRojo').val() || 0,
                Estatus: true
            };

            $.ajax({
                url: '@Url.Action("GuardarCuestionario", "Formularios")',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function (r) {
                    if (r.success) {
                        $('#mensajeGuardado').text(r.message);
                        $('#modalGuardado').modal('show');
                    } else {
                        showAlert(r.error || 'Error al guardar', 'error');
                    }
                }
            });
        });

        $('#btnAceptarGuardado').click(function () {
            window.location.href = '@Url.Action("Index", "Formularios")';
        });

        function cargarCategorias() {
            $.get('@Url.Action("ListarCategorias", "Formularios")', function (r) {
                if (r.success) {
                    const select = $('#categoria');
                    select.empty();
                    r.data.forEach(c => select.append(`<option value="${c.id}">${c.nombre}</option>`));
                    //if (categoriaId) {
                        //select.val(categoriaId);
                    //}
                }
            });
        }
        
        function cargarRolesAsignaciones() {
            const multiSelects = ['#rolSelect1', '#rolSelect3'];
            const singleSelect = '#rolSelect2';

            multiSelects.forEach(s => {
                if ($(s).hasClass('select2-hidden-accessible')) {
                    $(s).select2('destroy');
                }
                $(s).empty();
            });
            $(singleSelect).empty().append('<option value="">-- Seleccione --</option>');

            $.get('@Url.Action("ListarGestion", "Rol")', function (r) {
                if (r.success) {
                    r.data.forEach(rol => {
                        multiSelects.forEach(s => $(s).append(`<option value="${rol.id}">${rol.nombre}</option>`));
                        $(singleSelect).append(`<option value="${rol.id}">${rol.nombre}</option>`);
                    });

                    multiSelects.forEach(s => $(s).select2({
                        placeholder: '-- Seleccione --',
                        width: '100%'
                    }));
                } else {
                    showAlert(r.error || 'Error al cargar roles', 'error');
                }
            });
        }

        $('#btnAsignaciones').click(function () {
            cargarRolesAsignaciones();
            $('#modalAsignaciones').modal('show');
        });

        $('#btnGuardarAsignaciones').click(function () {
            const data = {
                FormularioId: parseInt($('#idFormularioAsignacion').val() || 0),
                Rol1: ($('#rolSelect1').val() || []).map(Number),
                Rol2: $('#rolSelect2').val(),
                Rol3: ($('#rolSelect3').val() || []).map(Number)
            };

            $.ajax({
                url: '@Url.Action("GuardarAsignaciones", "Formularios")',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function (r) {
                    if (r.success) {
                        showAlert(r.message || 'Asignaciones guardadas correctamente', 'success');
                        $('#modalAsignaciones').modal('hide');
                    } else {
                        showAlert(r.error || 'Error al guardar asignaciones', 'error');
                    }
                },
                error: function () {
                    showAlert('Error en la petición', 'error');
                }
            });
        });
    </script>
}
